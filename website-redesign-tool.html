<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SiteReveal ‚Äî AI Website Redesign Tool</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #2a2a38;
    --accent: #6c63ff;
    --accent2: #00e5a0;
    --accent3: #ff6b6b;
    --text: #e8e8f0;
    --muted: #6b6b88;
    --card: #14141e;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* === HEADER === */
  header {
    padding: 24px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: rgba(10,10,15,0.95);
    backdrop-filter: blur(12px);
    z-index: 100;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 2px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-dot {
    width: 10px; height: 10px;
    background: var(--accent2);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  .api-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 13px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  .api-badge:hover { border-color: var(--accent); color: var(--text); }
  .api-badge.connected { border-color: var(--accent2); color: var(--accent2); }
  .api-badge .dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; }

  /* === HERO === */
  .hero {
    padding: 80px 40px 60px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .hero::before {
    content: '';
    position: absolute;
    top: -100px; left: 50%; transform: translateX(-50%);
    width: 600px; height: 400px;
    background: radial-gradient(ellipse, rgba(108,99,255,0.15) 0%, transparent 70%);
    pointer-events: none;
  }

  .hero-tag {
    display: inline-block;
    background: rgba(108,99,255,0.15);
    border: 1px solid rgba(108,99,255,0.4);
    color: #a89fff;
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 6px 16px;
    border-radius: 100px;
    margin-bottom: 24px;
  }

  h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(52px, 8vw, 100px);
    line-height: 0.9;
    letter-spacing: 2px;
    margin-bottom: 20px;
  }

  h1 span { color: var(--accent2); }

  .hero p {
    font-size: 18px;
    color: var(--muted);
    max-width: 520px;
    margin: 0 auto 48px;
    line-height: 1.6;
    font-weight: 300;
  }

  /* === MAIN INPUT === */
  .input-zone {
    max-width: 680px;
    margin: 0 auto;
    position: relative;
  }

  .url-input-wrap {
    display: flex;
    gap: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .url-input-wrap:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(108,99,255,0.15);
  }

  .url-prefix {
    padding: 18px 16px 18px 20px;
    color: var(--muted);
    font-size: 15px;
    background: var(--surface2);
    border-right: 1px solid var(--border);
    white-space: nowrap;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
  }

  #urlInput {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-size: 16px;
    padding: 18px 16px;
    font-family: 'DM Mono', monospace;
  }

  #urlInput::placeholder { color: var(--muted); }

  #analyzeBtn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 14px 28px;
    font-size: 15px;
    font-weight: 600;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    letter-spacing: 0.3px;
  }

  #analyzeBtn:hover { background: #7c74ff; }
  #analyzeBtn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* === PROGRESS === */
  #progressSection {
    display: none;
    max-width: 680px;
    margin: 48px auto 0;
  }

  .progress-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
  }

  .spinner {
    width: 20px; height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .progress-title {
    font-size: 16px;
    font-weight: 500;
  }

  .steps {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .step {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 18px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    color: var(--muted);
    transition: all 0.3s;
  }

  .step.active {
    border-color: var(--accent);
    color: var(--text);
    background: rgba(108,99,255,0.08);
  }

  .step.done {
    border-color: rgba(0,229,160,0.3);
    color: var(--accent2);
    background: rgba(0,229,160,0.05);
  }

  .step-icon { font-size: 18px; width: 24px; text-align: center; }

  /* === RESULTS === */
  #resultsSection {
    display: none;
    padding: 40px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    flex-wrap: gap;
    gap: 16px;
  }

  .results-header h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 1px;
  }

  .results-header h2 span { color: var(--accent2); }

  .action-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 18px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

  .btn-primary {
    background: var(--accent2);
    color: #0a0a0f;
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-primary:hover { background: #00ffb3; }

  /* === INTEL STRIP === */
  .intel-strip {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 32px;
  }

  .intel-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
  }

  .intel-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--muted);
    margin-bottom: 8px;
    font-weight: 500;
  }

  .intel-value {
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .color-swatches {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .swatch {
    width: 22px; height: 22px;
    border-radius: 5px;
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: transform 0.15s;
    position: relative;
  }
  .swatch:hover { transform: scale(1.3); z-index: 1; }

  /* === COMPARISON === */
  .comparison-wrap {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    height: 700px;
  }

  @media (max-width: 900px) {
    .comparison-wrap { grid-template-columns: 1fr; height: auto; }
    .frame-box { height: 500px; }
  }

  .frame-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .frame-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
  }

  .frame-label-left {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    font-weight: 500;
  }

  .before-tag {
    background: rgba(255,107,107,0.15);
    color: var(--accent3);
    border: 1px solid rgba(255,107,107,0.3);
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 100px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .after-tag {
    background: rgba(0,229,160,0.15);
    color: var(--accent2);
    border: 1px solid rgba(0,229,160,0.3);
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 100px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .frame-url {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    background: var(--surface2);
    padding: 4px 10px;
    border-radius: 6px;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .frame-body { flex: 1; overflow: hidden; position: relative; }

  iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  .browser-chrome {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    flex-shrink: 0;
  }

  .bc-dot {
    width: 10px; height: 10px; border-radius: 50%;
  }

  /* === ANALYSIS PANEL === */
  .analysis-section {
    margin-top: 32px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  @media (max-width: 900px) {
    .analysis-section { grid-template-columns: 1fr; }
  }

  .analysis-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
  }

  .analysis-card h3 {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--muted);
    margin-bottom: 16px;
    font-weight: 500;
  }

  .analysis-card p {
    font-size: 14px;
    line-height: 1.7;
    color: #b0b0c8;
  }

  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .tag {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 4px 12px;
    font-size: 13px;
    color: var(--muted);
  }

  /* === ERROR === */
  #errorBox {
    display: none;
    max-width: 680px;
    margin: 32px auto 0;
    background: rgba(255,107,107,0.08);
    border: 1px solid rgba(255,107,107,0.3);
    border-radius: 12px;
    padding: 20px 24px;
    color: #ff9999;
    font-size: 14px;
    line-height: 1.6;
  }

  /* === FOOTER === */
  footer {
    border-top: 1px solid var(--border);
    padding: 24px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 60px;
  }

  footer p { font-size: 13px; color: var(--muted); }

  /* === FRAME SCALE TRICK === */
  .scaled-frame-wrap {
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: relative;
  }

  .iframe-scaled {
    width: 1280px;
    height: 900px;
    transform: scale(0.5);
    transform-origin: top left;
    border: none;
    pointer-events: auto;
  }

  .frame-inner {
    width: 100%;
    height: 100%;
    overflow: auto;
  }

  /* Blocker overlay for original site */
  .frame-blocked {
    display: none;
    position: absolute;
    inset: 0;
    background: var(--surface);
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 12px;
    text-align: center;
    padding: 32px;
  }

  .frame-blocked p {
    color: var(--muted);
    font-size: 14px;
    line-height: 1.6;
  }

  .frame-blocked .big-icon { font-size: 48px; }

  .open-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    color: var(--text);
    text-decoration: none;
    font-size: 14px;
    transition: border-color 0.2s;
  }
  .open-link:hover { border-color: var(--accent); }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-dot"></div>
    SITEREVEAL
  </div>
</header>

<!-- HERO -->
<section class="hero">
  <div class="hero-tag">AI-Powered ¬∑ Brand-Consistent ¬∑ Instant Preview</div>
  <h1>SEE YOUR<br><span>NEW SITE</span><br>INSTANTLY</h1>
  <p>Enter any website URL and watch AI analyze, understand, and redesign it ‚Äî preserving your brand while transforming the experience.</p>

  <div class="input-zone">
    <div class="url-input-wrap">
      <div class="url-prefix">https://</div>
      <input type="text" id="urlInput" placeholder="yourcompany.com" autocomplete="off">
      <button id="analyzeBtn" onclick="startAnalysis()">Analyze & Redesign ‚Üí</button>
    </div>
  </div>
</section>

<!-- PROGRESS -->
<div id="progressSection">
  <div class="progress-header">
    <div class="spinner"></div>
    <div class="progress-title" id="progressTitle">Analyzing website...</div>
  </div>
  <div class="steps" id="stepsContainer">
    <div class="step" id="step1"><div class="step-icon">üó∫Ô∏è</div> Fetching sitemap & page structure</div>
    <div class="step" id="step2"><div class="step-icon">üé®</div> Extracting color palette & fonts</div>
    <div class="step" id="step3"><div class="step-icon">üîó</div> Mapping internal links & navigation</div>
    <div class="step" id="step4"><div class="step-icon">üìã</div> Reading schema & structured data</div>
    <div class="step" id="step5"><div class="step-icon">üìù</div> Analyzing content, market & offerings</div>
    <div class="step" id="step6"><div class="step-icon">ü§ñ</div> Generating AI-optimized homepage...</div>
  </div>
</div>

<!-- ERROR -->
<div id="errorBox"></div>

<!-- RESULTS -->
<div id="resultsSection">

  <div class="results-header">
    <h2>REDESIGN <span>COMPLETE</span></h2>
    <div class="action-row">
      <button class="btn-secondary" onclick="downloadHTML()">‚¨á Download HTML</button>
      <button class="btn-secondary" onclick="resetTool()">‚Üê New Analysis</button>
      <button class="btn-primary" onclick="copyHTML()">Copy Generated HTML</button>
    </div>
  </div>

  <!-- INTEL STRIP -->
  <div class="intel-strip" id="intelStrip"></div>

  <!-- SIDE BY SIDE -->
  <div class="comparison-wrap">

    <!-- BEFORE -->
    <div class="frame-box">
      <div class="frame-label">
        <div class="frame-label-left">
          <div class="before-tag">Before</div>
          <span>Current Site</span>
        </div>
        <div class="frame-url" id="beforeUrl"></div>
      </div>
      <div class="browser-chrome">
        <div class="bc-dot" style="background:#ff5f56"></div>
        <div class="bc-dot" style="background:#ffbd2e"></div>
        <div class="bc-dot" style="background:#27c93f"></div>
      </div>
      <div class="frame-body">
        <iframe id="beforeFrame" sandbox="allow-scripts allow-same-origin" loading="lazy"></iframe>
        <div class="frame-blocked" id="frameBlocked">
          <div class="big-icon">üîí</div>
          <p>This site prevents embedding in iframes (X-Frame-Options policy). Open it directly to compare.</p>
          <a href="#" id="openOriginal" class="open-link" target="_blank">‚Üó Open Original Site</a>
        </div>
      </div>
    </div>

    <!-- AFTER -->
    <div class="frame-box">
      <div class="frame-label">
        <div class="frame-label-left">
          <div class="after-tag">After</div>
          <span>AI Redesign</span>
        </div>
        <div class="frame-url">AI Generated</div>
      </div>
      <div class="browser-chrome">
        <div class="bc-dot" style="background:#ff5f56"></div>
        <div class="bc-dot" style="background:#ffbd2e"></div>
        <div class="bc-dot" style="background:#27c93f"></div>
      </div>
      <div class="frame-body">
        <iframe id="afterFrame"></iframe>
      </div>
    </div>

  </div>

  <!-- ANALYSIS PANELS -->
  <div class="analysis-section" id="analysisCards"></div>

</div>

<!-- FOOTER -->
<footer>
  <p>SiteReveal ‚Äî Powered by Claude AI ¬∑ Your API key stays in your browser</p>
  <p>Built to convert prospects into clients</p>
</footer>

<script>
// =====================
// STATE
// =====================
let generatedHTML = '';
let currentUrl = '';

// =====================
// ANALYSIS TRIGGER
// =====================

// =====================
// CORS PROXY FETCH
// =====================
async function fetchSite(url) {
  const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
  const res = await fetch(proxyUrl);
  if (!res.ok) throw new Error(`Proxy fetch failed: ${res.status}`);
  const data = await res.json();
  return data.contents || '';
}

// =====================
// EXTRACT SITE DATA
// =====================
function extractSiteData(html, baseUrl) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  // Meta
  const title = doc.querySelector('title')?.textContent?.trim() || '';
  const description = doc.querySelector('meta[name="description"]')?.content ||
                      doc.querySelector('meta[property="og:description"]')?.content || '';
  const ogImage = doc.querySelector('meta[property="og:image"]')?.content || '';
  const siteName = doc.querySelector('meta[property="og:site_name"]')?.content || title;
  const keywords = doc.querySelector('meta[name="keywords"]')?.content || '';

  // Headings
  const h1s = [...doc.querySelectorAll('h1')].map(h => h.textContent.trim()).filter(Boolean).slice(0, 5);
  const h2s = [...doc.querySelectorAll('h2')].map(h => h.textContent.trim()).filter(Boolean).slice(0, 8);
  const h3s = [...doc.querySelectorAll('h3')].map(h => h.textContent.trim()).filter(Boolean).slice(0, 8);

  // Paragraphs
  const paras = [...doc.querySelectorAll('p')].map(p => p.textContent.trim())
    .filter(t => t.length > 30).slice(0, 10);

  // Navigation links
  const navLinks = [...doc.querySelectorAll('nav a, header a')]
    .map(a => ({ text: a.textContent.trim(), href: a.href }))
    .filter(a => a.text.length > 0 && a.text.length < 50)
    .slice(0, 12);

  // All internal links
  const allLinks = [...doc.querySelectorAll('a[href]')]
    .map(a => a.textContent.trim())
    .filter(t => t.length > 0 && t.length < 40)
    .slice(0, 20);

  // Colors from inline styles and style tags
  const colors = new Set();
  const colorRegex = /#(?:[0-9a-fA-F]{3}){1,2}\b|rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)/g;

  [...doc.querySelectorAll('style')].forEach(s => {
    const matches = s.textContent.match(colorRegex) || [];
    matches.forEach(c => colors.add(c));
  });

  [...doc.querySelectorAll('[style]')].forEach(el => {
    const matches = el.getAttribute('style').match(colorRegex) || [];
    matches.forEach(c => colors.add(c));
  });

  // Filter out pure black/white
  const filteredColors = [...colors].filter(c => {
    const lower = c.toLowerCase();
    return !['#000', '#000000', '#fff', '#ffffff', '#0000', 'rgb(0,0,0)', 'rgb(255,255,255)'].includes(lower.replace(/\s/g,''));
  }).slice(0, 12);

  // Fonts
  const fonts = new Set();
  const fontRegex = /font-family\s*:\s*([^;}"']+)/gi;
  [...doc.querySelectorAll('style')].forEach(s => {
    let m;
    while ((m = fontRegex.exec(s.textContent)) !== null) {
      fonts.add(m[1].trim().replace(/['"]/g, '').split(',')[0].trim());
    }
  });

  // Logo
  const logoEl = doc.querySelector('header img, .logo img, [class*="logo"] img, [id*="logo"] img, nav img');
  const logoSrc = logoEl?.src || '';
  const logoAlt = logoEl?.alt || siteName;

  // Schema.org
  const schemas = [];
  doc.querySelectorAll('script[type="application/ld+json"]').forEach(s => {
    try {
      const parsed = JSON.parse(s.textContent);
      schemas.push(parsed);
    } catch(e) {}
  });

  // CTA buttons
  const ctas = [...doc.querySelectorAll('button, .btn, [class*="button"], a[class*="cta"]')]
    .map(el => el.textContent.trim())
    .filter(t => t.length > 0 && t.length < 50)
    .slice(0, 8);

  // Images count
  const imageCount = doc.querySelectorAll('img').length;

  // Social links
  const socials = [...doc.querySelectorAll('a[href*="facebook"], a[href*="twitter"], a[href*="instagram"], a[href*="linkedin"], a[href*="youtube"], a[href*="tiktok"]')]
    .map(a => {
      const href = a.href;
      if (href.includes('facebook')) return 'Facebook';
      if (href.includes('twitter') || href.includes('x.com')) return 'Twitter/X';
      if (href.includes('instagram')) return 'Instagram';
      if (href.includes('linkedin')) return 'LinkedIn';
      if (href.includes('youtube')) return 'YouTube';
      if (href.includes('tiktok')) return 'TikTok';
      return null;
    }).filter(Boolean);

  return {
    title, description, ogImage, siteName, keywords,
    h1s, h2s, h3s, paras, navLinks, allLinks,
    colors: filteredColors, fonts: [...fonts],
    logoSrc, logoAlt, schemas, ctas, imageCount, socials
  };
}

// =====================
// STEP MANAGEMENT
// =====================
function setStep(n, done = false) {
  for (let i = 1; i <= 6; i++) {
    const el = document.getElementById(`step${i}`);
    el.className = 'step';
    if (i < n) el.classList.add('done');
    else if (i === n) el.classList.add('active');
  }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// =====================
// MAIN ANALYSIS FLOW
// =====================
async function startAnalysis() {
  const rawUrl = document.getElementById('urlInput').value.trim();
  if (!rawUrl) { alert('Please enter a URL'); return; }

  let url = rawUrl;
  if (!url.startsWith('http')) url = 'https://' + url;
  currentUrl = url;

  // Reset UI
  document.getElementById('progressSection').style.display = 'block';
  document.getElementById('resultsSection').style.display = 'none';
  document.getElementById('errorBox').style.display = 'none';
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('progressTitle').textContent = 'Analyzing website...';
  setStep(1);

  try {
    // Steps 1-5 run instantly (all local extraction)
    setStep(1);
    const html = await fetchSite(url);
    if (!html) throw new Error('Could not fetch site content. The site may block external requests.');

    setStep(2);
    const siteData = extractSiteData(html, url);

    setStep(3);
    setStep(4);
    setStep(5);

    // Step 6 ‚Äî only async step: Claude API call
    setStep(6);
    document.getElementById('progressTitle').textContent = 'Generating your new homepage...';

    const generated = await generateHomepage(url, siteData);
    generatedHTML = generated;

    showResults(url, siteData, generated, html);

  } catch(err) {
    showError(err.message);
  } finally {
    document.getElementById('analyzeBtn').disabled = false;
  }
}

// =====================
// AI GENERATION
// =====================
async function generateHomepage(url, data) {
  const prompt = buildPrompt(url, data);

  const res = await fetch('/api/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt })
  });

  if (res.status === 429) {
    throw new Error('Too many requests ‚Äî please wait a few minutes before trying again.');
  }
  if (!res.ok) {
    const errData = await res.json().catch(() => ({}));
    throw new Error(`Generation error: ${errData.error || res.status}`);
  }

  // --- Stream the response, updating the after-frame live as tokens arrive ---
  const afterFrame = document.getElementById('afterFrame');
  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let accumulated = '';
  let frameDoc = null;

  // Open a live document in the after frame
  afterFrame.srcdoc = '<!DOCTYPE html><html><body style="background:#0a0a0f;color:#e8e8f0;font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;font-size:14px;">Generating...</body></html>';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    const chunk = decoder.decode(value, { stream: true });
    const lines = chunk.split('\n').filter(l => l.startsWith('data: '));

    for (const line of lines) {
      const jsonStr = line.slice(6).trim();
      if (jsonStr === '[DONE]') continue;
      try {
        const evt = JSON.parse(jsonStr);
        if (evt.type === 'content_block_delta' && evt.delta?.type === 'text_delta') {
          accumulated += evt.delta.text;

          // Live-update the after frame every ~500 chars once we have a full <html> tag
          if (accumulated.includes('<html') || accumulated.includes('<!DOCTYPE')) {
            const partial = accumulated + (accumulated.includes('</html>') ? '' : '</body></html>');
            afterFrame.srcdoc = extractHTML(partial) || partial;
          }
        }
      } catch(e) { /* skip malformed SSE line */ }
    }
  }

  // Final clean extraction
  const finalHTML = extractHTML(accumulated);
  if (finalHTML) return finalHTML;
  if (accumulated.includes('<html') || accumulated.includes('<!DOCTYPE')) return accumulated;
  throw new Error('AI did not return valid HTML. Please try again.');
}

function extractHTML(text) {
  const m = text.match(/```html\n?([\s\S]*?)```/);
  if (m) return m[1];
  const m2 = text.match(/(<!DOCTYPE[\s\S]*)/i);
  if (m2) return m2[1];
  const m3 = text.match(/(<html[\s\S]*)/i);
  if (m3) return m3[1];
  return null;
}

function buildPrompt(url, d) {
  const colors = d.colors.length > 0 ? d.colors.slice(0,8).join(', ') : 'derive from brand context';
  const fonts  = d.fonts.length > 0  ? d.fonts.slice(0,3).join(', ')  : 'choose a modern pairing';
  const schema = d.schemas[0] ? `${d.schemas[0]['@type'] || ''} ‚Äî ${JSON.stringify(d.schemas[0]).slice(0,300)}` : 'none';

  // Score the existing copy quality: if h1s and paras look meaningful, reuse them
  const hasGoodCopy = d.h1s.length > 0 && d.paras.filter(p => p.length > 60).length >= 2;

  return `You are a senior web designer and conversion specialist. Redesign the homepage for: ${url}

SITE INTEL:
- Name: ${d.siteName || d.title}
- Description: ${d.description}
- Nav pages: ${d.navLinks.map(l=>l.text).join(', ') || 'none found'}
- H1s: ${d.h1s.join(' | ') || 'none'}
- H2s: ${d.h2s.slice(0,6).join(' | ') || 'none'}
- Key copy: ${d.paras.slice(0,4).join(' /// ')}
- CTAs: ${d.ctas.join(', ') || 'none'}
- Colors: ${colors}
- Fonts: ${fonts}
- Schema: ${schema}
- Socials: ${d.socials.join(', ') || 'none'}

COPY RULE: ${hasGoodCopy
  ? 'The existing copy is usable. REUSE the actual headlines, descriptions, and body copy from above ‚Äî do not invent new messaging. Improve clarity and phrasing only if something is genuinely weak.'
  : 'The existing copy is thin or missing. Write fresh, compelling copy that fits the business based on the site intel above.'}

OUTPUT: A single self-contained HTML file ‚Äî no external images (use CSS gradients/SVG icons), Google Fonts OK. Include:
‚Ä¢ Hero with headline + primary CTA
‚Ä¢ Services/features (3‚Äì5 cards with SVG icons)
‚Ä¢ Social proof section
‚Ä¢ About/trust section  
‚Ä¢ Final CTA banner
‚Ä¢ Footer with nav links and socials

Design rules: use the extracted brand colors, mobile-responsive flexbox/grid, smooth CSS hover states, clean modern typography. No Lorem Ipsum ever.

Return ONLY the raw HTML starting with <!DOCTYPE html>. No markdown, no explanation.`;
}

// =====================
// SHOW RESULTS
// =====================
function showResults(url, siteData, htmlOutput) {
  document.getElementById('progressSection').style.display = 'none';
  document.getElementById('resultsSection').style.display = 'block';

  // BEFORE frame
  document.getElementById('beforeUrl').textContent = url.replace('https://','').replace('http://','').slice(0, 30);
  document.getElementById('openOriginal').href = url;

  const beforeFrame = document.getElementById('beforeFrame');
  beforeFrame.src = url;

  // Check if iframe loads (many sites block X-Frame-Options)
  beforeFrame.onerror = () => showFrameBlocked();
  // Also set a timeout fallback
  setTimeout(() => {
    try {
      // If we can access contentDocument it loaded
      const doc = beforeFrame.contentDocument;
      if (!doc || doc.URL === 'about:blank') showFrameBlocked();
    } catch(e) {
      showFrameBlocked();
    }
  }, 4000);

  // AFTER frame
  const afterFrame = document.getElementById('afterFrame');
  const blob = new Blob([htmlOutput], { type: 'text/html' });
  afterFrame.src = URL.createObjectURL(blob);

  // INTEL STRIP
  buildIntelStrip(siteData);

  // ANALYSIS CARDS
  buildAnalysisCards(siteData, url);

  // Scroll to results
  document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function showFrameBlocked() {
  document.getElementById('beforeFrame').style.display = 'none';
  const blocked = document.getElementById('frameBlocked');
  blocked.style.display = 'flex';
}

function buildIntelStrip(d) {
  const strip = document.getElementById('intelStrip');

  const items = [
    {
      label: 'Site Name',
      value: `<div class="intel-value">${d.siteName || 'Unknown'}</div>`
    },
    {
      label: 'Nav Items Found',
      value: `<div class="intel-value">${d.navLinks.length} pages</div>`
    },
    {
      label: 'Color Palette',
      value: d.colors.length > 0
        ? `<div class="color-swatches">${d.colors.slice(0,8).map(c =>
            `<div class="swatch" style="background:${c}" title="${c}"></div>`).join('')}</div>`
        : '<div class="intel-value" style="color:var(--muted)">Not extracted</div>'
    },
    {
      label: 'Fonts Detected',
      value: `<div class="intel-value">${d.fonts.slice(0,2).join(', ') || 'System defaults'}</div>`
    },
    {
      label: 'Schema Type',
      value: `<div class="intel-value">${d.schemas[0]?.['@type'] || d.schemas[0]?.['@graph']?.[0]?.['@type'] || 'None found'}</div>`
    },
    {
      label: 'Social Presence',
      value: `<div class="intel-value">${d.socials.length > 0 ? d.socials.join(', ') : 'None detected'}</div>`
    }
  ];

  strip.innerHTML = items.map(item => `
    <div class="intel-card">
      <div class="intel-label">${item.label}</div>
      ${item.value}
    </div>
  `).join('');
}

function buildAnalysisCards(d, url) {
  const container = document.getElementById('analysisCards');

  // Infer business type
  const allText = [...d.h1s, ...d.h2s, ...d.paras].join(' ').toLowerCase();
  let bizType = 'Business';
  if (allText.match(/shop|product|buy|cart|price|order/)) bizType = 'E-commerce / Retail';
  else if (allText.match(/service|consult|hire|agency|team|expert/)) bizType = 'Service Business / Agency';
  else if (allText.match(/blog|article|news|read|publish/)) bizType = 'Content / Media';
  else if (allText.match(/software|app|platform|saas|tool|subscription/)) bizType = 'SaaS / Software';
  else if (allText.match(/restaurant|menu|food|dining|reserv/)) bizType = 'Restaurant / Hospitality';
  else if (allText.match(/doctor|medical|health|clinic|patient/)) bizType = 'Healthcare / Medical';
  else if (allText.match(/real estate|property|home|listing|agent/)) bizType = 'Real Estate';

  const navStr = d.navLinks.length > 0
    ? d.navLinks.map(l => l.text).join(', ')
    : 'No navigation found ‚Äî AI inferred structure from content.';

  const ctaStr = d.ctas.length > 0 ? d.ctas.join(', ') : 'None detected';

  container.innerHTML = `
    <div class="analysis-card">
      <h3>Business Intelligence</h3>
      <p><strong style="color:var(--accent2)">Detected Type:</strong> ${bizType}<br><br>
      ${d.description ? `<strong>Their pitch:</strong> "${d.description.slice(0,200)}"<br><br>` : ''}
      ${d.schemas[0]?.['@type'] ? `<strong>Schema says:</strong> ${d.schemas[0]['@type']} ‚Äî this helps AI understand their industry precisely.<br><br>` : ''}
      <strong>Pages / Navigation:</strong> ${navStr}</p>
    </div>

    <div class="analysis-card">
      <h3>Content Signals</h3>
      <p><strong style="color:var(--accent2)">Top Headlines:</strong><br>
      ${d.h1s.slice(0,3).map(h => `"${h}"`).join('<br>') || 'None extracted'}<br><br>
      <strong>Active CTAs:</strong> ${ctaStr}<br><br>
      ${d.socials.length > 0 ? `<strong>Social footprint:</strong> ${d.socials.join(', ')}` : 'No social links detected'}</p>
    </div>

    <div class="analysis-card">
      <h3>What We Improved</h3>
      <p>
      ‚ú¶ Restructured visual hierarchy for faster comprehension<br><br>
      ‚ú¶ Strengthened calls-to-action with urgency and clarity<br><br>
      ‚ú¶ Matched brand palette while modernizing the overall feel<br><br>
      ‚ú¶ Optimized navigation flow based on their actual page structure<br><br>
      ‚ú¶ Added mobile-first responsive layout throughout
      </p>
    </div>

    <div class="analysis-card">
      <h3>Next Steps</h3>
      <p>
      This is a <strong style="color:var(--accent2)">starting point</strong>, not the final product.<br><br>
      Your agency will:<br><br>
      ‚ú¶ Replace placeholder images with professional photography<br><br>
      ‚ú¶ Refine copy with real testimonials & data<br><br>
      ‚ú¶ Integrate with your CMS, CRM & analytics<br><br>
      ‚ú¶ A/B test CTAs and section layouts for peak conversion
      </p>
    </div>
  `;
}

// =====================
// UTILITY
// =====================
function showError(msg) {
  document.getElementById('progressSection').style.display = 'none';
  const box = document.getElementById('errorBox');
  box.style.display = 'block';
  box.innerHTML = `
    <strong>‚ö†Ô∏è Something went wrong</strong><br><br>
    ${msg}<br><br>
    <strong>Common fixes:</strong><br>
    ‚Ä¢ Make sure your API key is entered correctly<br>
    ‚Ä¢ Some sites block external fetching ‚Äî try a different URL<br>
    ‚Ä¢ Check your browser console for more details
  `;
}

function resetTool() {
  document.getElementById('resultsSection').style.display = 'none';
  document.getElementById('urlInput').value = '';
  document.getElementById('urlInput').focus();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function downloadHTML() {
  if (!generatedHTML) return;
  const blob = new Blob([generatedHTML], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'redesigned-homepage.html';
  a.click();
}

function copyHTML() {
  if (!generatedHTML) return;
  navigator.clipboard.writeText(generatedHTML).then(() => {
    const btn = document.querySelector('.btn-primary');
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = 'Copy Generated HTML', 2000);
  });
}

// Allow Enter key to trigger analysis
document.getElementById('urlInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') startAnalysis();
});
</script>

</body>
</html>
