<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SiteReveal â€” AI Website Redesign Tool</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #2a2a38;
    --accent: #6c63ff;
    --accent2: #00e5a0;
    --accent3: #ff6b6b;
    --text: #e8e8f0;
    --muted: #6b6b88;
    --card: #14141e;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* === HEADER === */
  header {
    padding: 24px 40px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: rgba(10,10,15,0.95);
    backdrop-filter: blur(12px);
    z-index: 100;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 2px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-dot {
    width: 10px; height: 10px;
    background: var(--accent2);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  /* === HERO === */
  .hero {
    padding: 80px 40px 60px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .hero::before {
    content: '';
    position: absolute;
    top: -100px; left: 50%; transform: translateX(-50%);
    width: 600px; height: 400px;
    background: radial-gradient(ellipse, rgba(108,99,255,0.15) 0%, transparent 70%);
    pointer-events: none;
  }

  .hero-tag {
    display: inline-block;
    background: rgba(108,99,255,0.15);
    border: 1px solid rgba(108,99,255,0.4);
    color: #a89fff;
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 6px 16px;
    border-radius: 100px;
    margin-bottom: 24px;
  }

  h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(52px, 8vw, 100px);
    line-height: 0.9;
    letter-spacing: 2px;
    margin-bottom: 20px;
  }

  h1 span { color: var(--accent2); }

  .hero p {
    font-size: 18px;
    color: var(--muted);
    max-width: 520px;
    margin: 0 auto 48px;
    line-height: 1.6;
    font-weight: 300;
  }

  /* === MAIN INPUT === */
  .input-zone {
    max-width: 680px;
    margin: 0 auto;
    position: relative;
  }

  .url-input-wrap {
    display: flex;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .url-input-wrap:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(108,99,255,0.15);
  }

  .url-prefix {
    padding: 18px 16px 18px 20px;
    color: var(--muted);
    background: var(--surface2);
    border-right: 1px solid var(--border);
    white-space: nowrap;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
  }

  #urlInput {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-size: 16px;
    padding: 18px 16px;
    font-family: 'DM Mono', monospace;
  }

  #urlInput::placeholder { color: var(--muted); }

  #analyzeBtn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 14px 28px;
    font-size: 15px;
    font-weight: 600;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  #analyzeBtn:hover { background: #7c74ff; }
  #analyzeBtn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* === PROGRESS === */
  #progressSection {
    display: none;
    max-width: 680px;
    margin: 48px auto 0;
    padding: 0 20px;
  }

  .progress-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
  }

  .spinner {
    width: 20px; height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .progress-title { font-size: 16px; font-weight: 500; }

  .steps { display: flex; flex-direction: column; gap: 10px; }

  .step {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 18px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    color: var(--muted);
    transition: all 0.3s;
  }

  .step.active { border-color: var(--accent); color: var(--text); background: rgba(108,99,255,0.08); }
  .step.done { border-color: rgba(0,229,160,0.3); color: var(--accent2); background: rgba(0,229,160,0.05); }
  .step-icon { font-size: 18px; width: 24px; text-align: center; }

  /* === RESULTS === */
  #resultsSection {
    display: none;
    padding: 40px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    gap: 16px;
    flex-wrap: wrap;
  }

  .results-header h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 1px;
  }

  .results-header h2 span { color: var(--accent2); }

  .action-row { display: flex; gap: 10px; flex-wrap: wrap; }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 18px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

  .btn-primary {
    background: var(--accent2);
    color: #0a0a0f;
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-primary:hover { background: #00ffb3; }

  /* === INTEL STRIP === */
  .intel-strip {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 32px;
  }

  .intel-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
  }

  .intel-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--muted);
    margin-bottom: 8px;
    font-weight: 500;
  }

  .intel-value {
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .color-swatches { display: flex; gap: 6px; flex-wrap: wrap; }

  .swatch {
    width: 22px; height: 22px;
    border-radius: 5px;
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: transform 0.15s;
  }
  .swatch:hover { transform: scale(1.3); z-index: 1; }

  /* === COMPARISON === */
  .comparison-wrap {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    height: 700px;
  }

  @media (max-width: 900px) {
    .comparison-wrap { grid-template-columns: 1fr; height: auto; }
    .frame-box { height: 500px; }
  }

  .frame-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .frame-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
  }

  .frame-label-left {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    font-weight: 500;
  }

  .before-tag {
    background: rgba(255,107,107,0.15);
    color: var(--accent3);
    border: 1px solid rgba(255,107,107,0.3);
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 100px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .after-tag {
    background: rgba(0,229,160,0.15);
    color: var(--accent2);
    border: 1px solid rgba(0,229,160,0.3);
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 100px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .frame-url {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    background: var(--surface2);
    padding: 4px 10px;
    border-radius: 6px;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .frame-body { flex: 1; overflow: hidden; position: relative; }

  iframe { width: 100%; height: 100%; border: none; display: block; }

  .browser-chrome {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    flex-shrink: 0;
  }

  .bc-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* Blocked overlay for before frame */
  .frame-blocked {
    display: none;
    position: absolute;
    inset: 0;
    background: var(--surface);
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    text-align: center;
    padding: 32px;
  }

  .frame-blocked .big-icon { font-size: 48px; }
  .frame-blocked p { color: var(--muted); font-size: 14px; line-height: 1.6; }

  .open-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    color: var(--text);
    text-decoration: none;
    font-size: 14px;
    transition: border-color 0.2s;
  }
  .open-link:hover { border-color: var(--accent); }

  /* === ANALYSIS CARDS === */
  .analysis-section {
    margin-top: 32px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  @media (max-width: 900px) { .analysis-section { grid-template-columns: 1fr; } }

  .analysis-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
  }

  .analysis-card h3 {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--muted);
    margin-bottom: 16px;
    font-weight: 500;
  }

  .analysis-card p { font-size: 14px; line-height: 1.7; color: #b0b0c8; }

  /* === ERROR === */
  #errorBox {
    display: none;
    max-width: 680px;
    margin: 32px auto 0;
    background: rgba(255,107,107,0.08);
    border: 1px solid rgba(255,107,107,0.3);
    border-radius: 12px;
    padding: 20px 24px;
    color: #ff9999;
    font-size: 14px;
    line-height: 1.6;
  }

  /* === FOOTER === */
  footer {
    border-top: 1px solid var(--border);
    padding: 24px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 60px;
  }

  footer p { font-size: 13px; color: var(--muted); }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-dot"></div>
    SITEREVEAL
  </div>
</header>

<!-- HERO -->
<section class="hero">
  <div class="hero-tag">AI-Powered Â· Brand-Consistent Â· Instant Preview</div>
  <h1>SEE YOUR<br><span>NEW SITE</span><br>INSTANTLY</h1>
  <p>Enter any website URL and watch AI analyze, understand, and redesign it â€” preserving your brand while transforming the experience.</p>

  <div class="input-zone">
    <div class="url-input-wrap">
      <div class="url-prefix">https://</div>
      <input type="text" id="urlInput" placeholder="yourcompany.com" autocomplete="off">
      <button id="analyzeBtn">Analyze & Redesign â†’</button>
    </div>
  </div>
</section>

<!-- PROGRESS -->
<div id="progressSection">
  <div class="progress-header">
    <div class="spinner"></div>
    <div class="progress-title" id="progressTitle">Analyzing website...</div>
  </div>
  <div class="steps">
    <div class="step" id="step1"><div class="step-icon">ğŸ—ºï¸</div> Fetching sitemap & page structure</div>
    <div class="step" id="step2"><div class="step-icon">ğŸ¨</div> Extracting color palette & fonts</div>
    <div class="step" id="step3"><div class="step-icon">ğŸ”—</div> Mapping internal links & navigation</div>
    <div class="step" id="step4"><div class="step-icon">ğŸ“‹</div> Reading schema & structured data</div>
    <div class="step" id="step5"><div class="step-icon">ğŸ“</div> Analyzing content, market & offerings</div>
    <div class="step" id="step6"><div class="step-icon">ğŸ¤–</div> Generating AI-optimized homepage...</div>
  </div>
</div>

<!-- ERROR -->
<div id="errorBox"></div>

<!-- RESULTS -->
<div id="resultsSection">

  <div class="results-header">
    <h2>REDESIGN <span>COMPLETE</span></h2>
    <div class="action-row">
      <button class="btn-secondary" id="downloadBtn">â¬‡ Download HTML</button>
      <button class="btn-secondary" id="resetBtn">â† New Analysis</button>
      <button class="btn-primary" id="copyBtn">Copy Generated HTML</button>
    </div>
  </div>

  <div class="intel-strip" id="intelStrip"></div>

  <div class="comparison-wrap">

    <!-- BEFORE -->
    <div class="frame-box">
      <div class="frame-label">
        <div class="frame-label-left">
          <div class="before-tag">Before</div>
          <span>Current Site</span>
        </div>
        <div class="frame-url" id="beforeUrl"></div>
      </div>
      <div class="browser-chrome">
        <div class="bc-dot" style="background:#ff5f56"></div>
        <div class="bc-dot" style="background:#ffbd2e"></div>
        <div class="bc-dot" style="background:#27c93f"></div>
      </div>
      <div class="frame-body">
        <iframe id="beforeFrame"></iframe>
        <div class="frame-blocked" id="frameBlocked">
          <div class="big-icon">ğŸ”’</div>
          <p>This site blocks iframe embedding. Open it directly to compare.</p>
          <a href="#" id="openOriginal" class="open-link" target="_blank">â†— Open Original Site</a>
        </div>
      </div>
    </div>

    <!-- AFTER -->
    <div class="frame-box">
      <div class="frame-label">
        <div class="frame-label-left">
          <div class="after-tag">After</div>
          <span>AI Redesign</span>
        </div>
        <div class="frame-url">AI Generated</div>
      </div>
      <div class="browser-chrome">
        <div class="bc-dot" style="background:#ff5f56"></div>
        <div class="bc-dot" style="background:#ffbd2e"></div>
        <div class="bc-dot" style="background:#27c93f"></div>
      </div>
      <div class="frame-body">
        <iframe id="afterFrame"></iframe>
      </div>
    </div>

  </div>

  <div class="analysis-section" id="analysisCards"></div>

</div>

<!-- FOOTER -->
<footer>
  <p>SiteReveal â€” Powered by Claude AI</p>
  <p>Built to convert prospects into clients</p>
</footer>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let generatedHTML = '';
let currentUrl = '';

// â”€â”€ SERVER-SIDE FETCH (our own Vercel function â€” no CORS issues) â”€â”€
async function fetchSite(url) {
  const res = await fetch('/api/fetch', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url })
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || `Could not fetch site (${res.status})`);
  }
  const data = await res.json();
  if (!data.html) throw new Error('Site returned empty content.');
  return data.html;
}

// â”€â”€ EXTRACT SITE DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractSiteData(html, baseUrl) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  const title    = doc.querySelector('title')?.textContent?.trim() || '';
  const description = doc.querySelector('meta[name="description"]')?.content
                   || doc.querySelector('meta[property="og:description"]')?.content || '';
  const siteName = doc.querySelector('meta[property="og:site_name"]')?.content || title;
  const keywords = doc.querySelector('meta[name="keywords"]')?.content || '';

  const h1s = [...doc.querySelectorAll('h1')].map(h => h.textContent.trim()).filter(Boolean).slice(0, 5);
  const h2s = [...doc.querySelectorAll('h2')].map(h => h.textContent.trim()).filter(Boolean).slice(0, 8);
  const h3s = [...doc.querySelectorAll('h3')].map(h => h.textContent.trim()).filter(Boolean).slice(0, 8);
  const paras = [...doc.querySelectorAll('p')].map(p => p.textContent.trim()).filter(t => t.length > 30).slice(0, 10);

  const navLinks = [...doc.querySelectorAll('nav a, header a')]
    .map(a => ({ text: a.textContent.trim(), href: a.href }))
    .filter(a => a.text.length > 0 && a.text.length < 50).slice(0, 12);

  // Colors
  const colors = new Set();
  const colorRegex = /#(?:[0-9a-fA-F]{3}){1,2}\b|rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)/g;
  [...doc.querySelectorAll('style')].forEach(s => (s.textContent.match(colorRegex) || []).forEach(c => colors.add(c)));
  [...doc.querySelectorAll('[style]')].forEach(el => (el.getAttribute('style').match(colorRegex) || []).forEach(c => colors.add(c)));
  const filteredColors = [...colors].filter(c => {
    const n = c.toLowerCase().replace(/\s/g,'');
    return !['#000','#000000','#fff','#ffffff','rgb(0,0,0)','rgb(255,255,255)'].includes(n);
  }).slice(0, 12);

  // Fonts
  const fonts = new Set();
  const fontRegex = /font-family\s*:\s*([^;}"']+)/gi;
  [...doc.querySelectorAll('style')].forEach(s => {
    let m; while ((m = fontRegex.exec(s.textContent)) !== null)
      fonts.add(m[1].trim().replace(/['"]/g,'').split(',')[0].trim());
  });

  // Schema
  const schemas = [];
  doc.querySelectorAll('script[type="application/ld+json"]').forEach(s => {
    try { schemas.push(JSON.parse(s.textContent)); } catch(e) {}
  });

  // CTAs
  const ctas = [...doc.querySelectorAll('button, .btn, [class*="button"], a[class*="cta"]')]
    .map(el => el.textContent.trim()).filter(t => t.length > 0 && t.length < 50).slice(0, 8);

  // Socials
  const socials = [...doc.querySelectorAll('a[href*="facebook"],a[href*="twitter"],a[href*="instagram"],a[href*="linkedin"],a[href*="youtube"],a[href*="tiktok"]')]
    .map(a => {
      const h = a.href;
      if (h.includes('facebook'))  return 'Facebook';
      if (h.includes('twitter') || h.includes('x.com')) return 'Twitter/X';
      if (h.includes('instagram')) return 'Instagram';
      if (h.includes('linkedin'))  return 'LinkedIn';
      if (h.includes('youtube'))   return 'YouTube';
      if (h.includes('tiktok'))    return 'TikTok';
      return null;
    }).filter(Boolean);

  return { title, description, siteName, keywords, h1s, h2s, h3s, paras, navLinks,
           colors: filteredColors, fonts: [...fonts], schemas, ctas, socials };
}

// â”€â”€ STEP UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStep(n) {
  for (let i = 1; i <= 6; i++) {
    const el = document.getElementById(`step${i}`);
    el.className = 'step' + (i < n ? ' done' : i === n ? ' active' : '');
  }
}

// â”€â”€ MAIN FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startAnalysis() {
  const rawUrl = document.getElementById('urlInput').value.trim();
  if (!rawUrl) { alert('Please enter a URL'); return; }

  let url = rawUrl.startsWith('http') ? rawUrl : 'https://' + rawUrl;
  currentUrl = url;

  document.getElementById('progressSection').style.display = 'block';
  document.getElementById('resultsSection').style.display  = 'none';
  document.getElementById('errorBox').style.display        = 'none';
  document.getElementById('analyzeBtn').disabled           = true;
  document.getElementById('progressTitle').textContent     = 'Analyzing website...';
  setStep(1);

  try {
    const html = await fetchSite(url);
    setStep(2);
    const siteData = extractSiteData(html, url);
    setStep(3); setStep(4); setStep(5);

    setStep(6);
    document.getElementById('progressTitle').textContent = 'Generating your new homepage...';

    const generated = await generateHomepage(url, siteData);
    generatedHTML = generated;

    showResults(url, siteData, generated, html);

  } catch(err) {
    showError(err.message);
  } finally {
    document.getElementById('analyzeBtn').disabled = false;
  }
}

// â”€â”€ AI GENERATION (streaming via Vercel proxy) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateHomepage(url, data) {
  const prompt = buildPrompt(url, data);

  const res = await fetch('/api/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt })
  });

  if (res.status === 429) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || 'Too many requests â€” please wait a few minutes and try again.');
  }
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(`Generation error: ${err.error || res.status}`);
  }

  // Stream tokens and live-update the After frame
  const afterFrame = document.getElementById('afterFrame');
  afterFrame.srcdoc = '<html><body style="background:#0a0a0f;color:#e8e8f0;font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;font-size:15px;gap:12px"><div style="width:18px;height:18px;border:2px solid #333;border-top-color:#6c63ff;border-radius:50%;animation:s 0.8s linear infinite"></div>Generating...<style>@keyframes s{to{transform:rotate(360deg)}}</style></body></html>';

  const reader  = res.body.getReader();
  const decoder = new TextDecoder();
  let accumulated = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    const lines = decoder.decode(value, { stream: true }).split('\n').filter(l => l.startsWith('data: '));
    for (const line of lines) {
      const jsonStr = line.slice(6).trim();
      if (jsonStr === '[DONE]') continue;
      try {
        const evt = JSON.parse(jsonStr);
        if (evt.type === 'content_block_delta' && evt.delta?.type === 'text_delta') {
          accumulated += evt.delta.text;
          // Live preview once we have enough HTML to show
          if (accumulated.length > 200 && (accumulated.includes('<html') || accumulated.includes('<!DOCTYPE'))) {
            const preview = extractHTML(accumulated);
            if (preview) afterFrame.srcdoc = preview;
          }
        }
      } catch(e) { /* skip malformed SSE lines */ }
    }
  }

  const finalHTML = extractHTML(accumulated);
  if (finalHTML) return finalHTML;
  if (accumulated.includes('<html') || accumulated.includes('<!DOCTYPE')) return accumulated;
  throw new Error('AI did not return valid HTML â€” please try again.');
}

function extractHTML(text) {
  const m1 = text.match(/```html\n?([\s\S]*?)```/);
  if (m1) return m1[1];
  const m2 = text.match(/(<!DOCTYPE[\s\S]*)/i);
  if (m2) return m2[1];
  const m3 = text.match(/(<html[\s\S]*)/i);
  if (m3) return m3[1];
  return null;
}

// â”€â”€ PROMPT BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPrompt(url, d) {
  const colors = d.colors.length > 0 ? d.colors.slice(0,8).join(', ') : 'derive from brand context';
  const fonts  = d.fonts.length  > 0 ? d.fonts.slice(0,3).join(', ')  : 'choose a modern pairing';
  const schema = d.schemas[0]
    ? `${d.schemas[0]['@type'] || ''} â€” ${JSON.stringify(d.schemas[0]).slice(0,300)}`
    : 'none';
  const hasGoodCopy = d.h1s.length > 0 && d.paras.filter(p => p.length > 60).length >= 2;

  return `You are a senior web designer and conversion specialist. Redesign the homepage for: ${url}

SITE INTEL:
- Name: ${d.siteName || d.title}
- Description: ${d.description}
- Nav pages: ${d.navLinks.map(l => l.text).join(', ') || 'none found'}
- H1s: ${d.h1s.join(' | ') || 'none'}
- H2s: ${d.h2s.slice(0,6).join(' | ') || 'none'}
- Key copy: ${d.paras.slice(0,4).join(' /// ')}
- CTAs: ${d.ctas.join(', ') || 'none'}
- Colors: ${colors}
- Fonts: ${fonts}
- Schema: ${schema}
- Socials: ${d.socials.join(', ') || 'none'}

COPY RULE: ${hasGoodCopy
  ? 'Existing copy is usable â€” REUSE actual headlines and body copy from above. Only improve wording if something is genuinely weak or unclear.'
  : 'Copy is thin or missing â€” write fresh, compelling copy that fits the business based on the site intel above.'}

OUTPUT: A single self-contained HTML file. No external images â€” use CSS gradients and SVG icons. Google Fonts are OK. Sections to include:
â€¢ Hero with headline + primary CTA button
â€¢ Services or features (3â€“5 cards with SVG icons)
â€¢ Social proof / testimonials section
â€¢ About / trust section
â€¢ Final CTA banner
â€¢ Footer with nav links and social icons

Design: use extracted brand colors, mobile-responsive flexbox/grid, CSS hover transitions, professional typography. No Lorem Ipsum ever.

Return ONLY raw HTML starting with <!DOCTYPE html>. No markdown fences, no explanation.`;
}

// â”€â”€ SHOW RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResults(url, siteData, htmlOutput, rawHTML) {
  document.getElementById('progressSection').style.display = 'none';
  document.getElementById('resultsSection').style.display  = 'block';

  // Before frame â€” inject the fetched HTML via srcdoc with a base tag for relative URLs
  const beforeFrame = document.getElementById('beforeFrame');
  document.getElementById('beforeUrl').textContent = url.replace(/https?:\/\//,'').slice(0, 30);
  document.getElementById('openOriginal').href = url;

  // Inject fetched HTML with base URL so images/styles attempt to load
  const withBase = rawHTML.replace(/<head>/i, `<head><base href="${url}">`);
  beforeFrame.srcdoc = withBase;

  // If srcdoc fails to render meaningfully, show the blocked overlay after a delay
  setTimeout(() => {
    try {
      const bd = beforeFrame.contentDocument;
      if (!bd || bd.body?.innerHTML?.trim() === '') showFrameBlocked();
    } catch(e) { showFrameBlocked(); }
  }, 3000);

  // After frame â€” already being updated live during streaming; set final version now
  document.getElementById('afterFrame').srcdoc = htmlOutput;

  buildIntelStrip(siteData);
  buildAnalysisCards(siteData, url);
  document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function showFrameBlocked() {
  document.getElementById('beforeFrame').style.display = 'none';
  const el = document.getElementById('frameBlocked');
  el.style.display = 'flex';
}

// â”€â”€ INTEL STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildIntelStrip(d) {
  document.getElementById('intelStrip').innerHTML = [
    { label: 'Site Name',      value: `<div class="intel-value">${d.siteName || 'Unknown'}</div>` },
    { label: 'Nav Pages',      value: `<div class="intel-value">${d.navLinks.length} found</div>` },
    { label: 'Color Palette',  value: d.colors.length > 0
        ? `<div class="color-swatches">${d.colors.slice(0,8).map(c => `<div class="swatch" style="background:${c}" title="${c}"></div>`).join('')}</div>`
        : `<div class="intel-value" style="color:var(--muted)">Not extracted</div>` },
    { label: 'Fonts',          value: `<div class="intel-value">${d.fonts.slice(0,2).join(', ') || 'System defaults'}</div>` },
    { label: 'Schema Type',    value: `<div class="intel-value">${d.schemas[0]?.['@type'] || d.schemas[0]?.['@graph']?.[0]?.['@type'] || 'None found'}</div>` },
    { label: 'Social Presence',value: `<div class="intel-value">${d.socials.length > 0 ? d.socials.join(', ') : 'None detected'}</div>` },
  ].map(i => `<div class="intel-card"><div class="intel-label">${i.label}</div>${i.value}</div>`).join('');
}

// â”€â”€ ANALYSIS CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildAnalysisCards(d, url) {
  const allText = [...d.h1s, ...d.h2s, ...d.paras].join(' ').toLowerCase();
  let bizType = 'Business';
  if      (allText.match(/shop|product|buy|cart|price|order/))           bizType = 'E-commerce / Retail';
  else if (allText.match(/service|consult|hire|agency|team|expert/))     bizType = 'Service Business / Agency';
  else if (allText.match(/blog|article|news|read|publish/))              bizType = 'Content / Media';
  else if (allText.match(/software|app|platform|saas|tool|subscription/)) bizType = 'SaaS / Software';
  else if (allText.match(/restaurant|menu|food|dining|reserv/))          bizType = 'Restaurant / Hospitality';
  else if (allText.match(/doctor|medical|health|clinic|patient/))        bizType = 'Healthcare / Medical';
  else if (allText.match(/real estate|property|home|listing|agent/))     bizType = 'Real Estate';

  document.getElementById('analysisCards').innerHTML = `
    <div class="analysis-card">
      <h3>Business Intelligence</h3>
      <p>
        <strong style="color:var(--accent2)">Detected Type:</strong> ${bizType}<br><br>
        ${d.description ? `<strong>Their pitch:</strong> "${d.description.slice(0,200)}"<br><br>` : ''}
        ${d.schemas[0]?.['@type'] ? `<strong>Schema:</strong> ${d.schemas[0]['@type']}<br><br>` : ''}
        <strong>Navigation:</strong> ${d.navLinks.length > 0 ? d.navLinks.map(l => l.text).join(', ') : 'None found'}
      </p>
    </div>
    <div class="analysis-card">
      <h3>Content Signals</h3>
      <p>
        <strong style="color:var(--accent2)">Top Headlines:</strong><br>
        ${d.h1s.slice(0,3).map(h => `"${h}"`).join('<br>') || 'None extracted'}<br><br>
        <strong>CTAs Found:</strong> ${d.ctas.join(', ') || 'None detected'}<br><br>
        ${d.socials.length > 0 ? `<strong>Social:</strong> ${d.socials.join(', ')}` : 'No social links detected'}
      </p>
    </div>
    <div class="analysis-card">
      <h3>What We Improved</h3>
      <p>
        âœ¦ Restructured visual hierarchy for faster comprehension<br><br>
        âœ¦ Strengthened calls-to-action with urgency and clarity<br><br>
        âœ¦ Matched brand palette while modernizing the overall feel<br><br>
        âœ¦ Optimized navigation based on actual page structure<br><br>
        âœ¦ Mobile-first responsive layout throughout
      </p>
    </div>
    <div class="analysis-card">
      <h3>Next Steps</h3>
      <p>
        This is a <strong style="color:var(--accent2)">starting point</strong>, not the final product.<br><br>
        Your agency will:<br><br>
        âœ¦ Replace placeholders with professional photography<br><br>
        âœ¦ Refine copy with real testimonials & data<br><br>
        âœ¦ Integrate CMS, CRM & analytics<br><br>
        âœ¦ A/B test CTAs and layouts for peak conversion
      </p>
    </div>`;
}

// â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showError(msg) {
  document.getElementById('progressSection').style.display = 'none';
  const box = document.getElementById('errorBox');
  box.style.display = 'block';
  box.innerHTML = `<strong>âš ï¸ Something went wrong</strong><br><br>${msg}<br><br>
    <strong>Common fixes:</strong><br>
    â€¢ Some sites block external fetching â€” try a different URL<br>
    â€¢ Check your browser console (F12) for more details`;
}

function resetTool() {
  document.getElementById('resultsSection').style.display = 'none';
  document.getElementById('errorBox').style.display = 'none';
  document.getElementById('urlInput').value = '';
  document.getElementById('urlInput').focus();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function downloadHTML() {
  if (!generatedHTML) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([generatedHTML], { type: 'text/html' }));
  a.download = 'redesigned-homepage.html';
  a.click();
}

function copyHTML() {
  if (!generatedHTML) return;
  navigator.clipboard.writeText(generatedHTML).then(() => {
    const btn = document.querySelector('.btn-primary');
    btn.textContent = 'âœ“ Copied!';
    setTimeout(() => btn.textContent = 'Copy Generated HTML', 2000);
  });
}

document.getElementById('urlInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') startAnalysis();
});
document.getElementById('analyzeBtn').addEventListener('click', startAnalysis);
document.getElementById('downloadBtn').addEventListener('click', downloadHTML);
document.getElementById('resetBtn').addEventListener('click', resetTool);
document.getElementById('copyBtn').addEventListener('click', copyHTML);
</script>

</body>
</html>
